name: Encoding & Quality Validation

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: "0 0 * * 0" # Weekly validation

jobs:
  encoding-validation:
    runs-on: ubuntu-latest
    name: Validate File Encoding

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check UTF-8 encoding
        run: |
          echo "ğŸ” Validating UTF-8 encoding..."
          found_issues=0

          # Check HTML files
          for file in $(find . -type f -name "*.html" ! -path "./.git/*" ! -path "./node_modules/*" ! -path "./_site/*"); do
            if file "$file" | grep -q "UTF-8.*BOM"; then
              echo "âŒ $file: Contains UTF-8 BOM"
              found_issues=$((found_issues + 1))
            fi
          done

          # Check YAML files
          for file in $(find . -type f \( -name "*.yml" -o -name "*.yaml" \) ! -path "./.git/*" ! -path "./node_modules/*"); do
            if grep -q $'\t' "$file"; then
              echo "âŒ $file: Contains tabs (YAML requires spaces)"
              found_issues=$((found_issues + 1))
            fi
          done

          if [ $found_issues -gt 0 ]; then
            echo "âš ï¸  Found $found_issues encoding/formatting issues"
            exit 1
          fi
          echo "âœ… All files have proper UTF-8 encoding"

  html-validation:
    runs-on: ubuntu-latest
    name: Validate HTML Structure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run HTMLHint
        run: npm run lint:html 2>&1 || true

  yaml-validation:
    runs-on: ubuntu-latest
    name: Validate YAML Syntax

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML files
        run: |
          echo "ğŸ” Validating YAML syntax..."

          # Install yamllint
          sudo apt-get update && sudo apt-get install -y yamllint

          # Check all YAML files
          yamllint -c "{extends: relaxed}" _data/ _config.yml 2>&1 || true

  jekyll-build:
    runs-on: ubuntu-latest
    name: Validate Jekyll Build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true

      - name: Build Jekyll site
        run: |
          bundle exec jekyll build --trace 2>&1 | tee build.log

      - name: Check for Jekyll errors
        run: |
          if grep -i "error\|liquid\|exception" build.log; then
            echo "âŒ Jekyll build encountered errors"
            exit 1
          fi
          echo "âœ… Jekyll build successful"

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: jekyll-build-log
          path: build.log
          retention-days: 7

  lint-js:
    runs-on: ubuntu-latest
    name: Lint JavaScript

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint:js 2>&1 || true

  summary:
    runs-on: ubuntu-latest
    name: Validation Summary
    needs:
      [
        encoding-validation,
        html-validation,
        yaml-validation,
        jekyll-build,
        lint-js,
      ]
    if: always()

    steps:
      - name: Check job status
        run: |
          echo "ğŸ“‹ Validation Summary"
          echo "===================="
          echo "âœ… Encoding validation: ${{ needs.encoding-validation.result }}"
          echo "âœ… HTML validation: ${{ needs.html-validation.result }}"
          echo "âœ… YAML validation: ${{ needs.yaml-validation.result }}"
          echo "âœ… Jekyll build: ${{ needs.jekyll-build.result }}"
          echo "âœ… JavaScript lint: ${{ needs.lint-js.result }}"

          if [ "${{ needs.jekyll-build.result }}" == "failure" ]; then
            echo ""
            echo "âš ï¸  Jekyll build failed. Check logs for details."
            exit 1
          fi
